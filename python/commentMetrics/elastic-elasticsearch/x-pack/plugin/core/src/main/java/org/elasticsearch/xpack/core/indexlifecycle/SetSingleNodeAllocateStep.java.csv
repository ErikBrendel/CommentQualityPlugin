commented;modifiers;parameterAmount;loc;comment;code
false;public;4;35;;@Override public void performAction(IndexMetaData indexMetaData, ClusterState clusterState, ClusterStateObserver observer, Listener listener) {     RoutingAllocation allocation = new RoutingAllocation(ALLOCATION_DECIDERS, clusterState.getRoutingNodes(), clusterState, null, System.nanoTime()).     List<String> validNodeIds = new ArrayList<>().     Optional<ShardRouting> anyShard = clusterState.getRoutingTable().allShards(indexMetaData.getIndex().getName()).stream().findAny().     if (anyShard.isPresent()) {         // Iterate through the nodes finding ones that are acceptable for the current allocation rules of the shard         for (RoutingNode node : clusterState.getRoutingNodes()) {             boolean canRemainOnCurrentNode = ALLOCATION_DECIDERS.canRemain(anyShard.get(), node, allocation).type() == Decision.Type.YES.             if (canRemainOnCurrentNode) {                 DiscoveryNode discoveryNode = node.node().                 validNodeIds.add(discoveryNode.getId()).             }         }         // Shuffle the list of nodes so the one we pick is random         Randomness.shuffle(validNodeIds).         Optional<String> nodeId = validNodeIds.stream().findAny().         if (nodeId.isPresent()) {             Settings settings = Settings.builder().put(IndexMetaData.INDEX_ROUTING_REQUIRE_GROUP_SETTING.getKey() + "_id", nodeId.get()).build().             UpdateSettingsRequest updateSettingsRequest = new UpdateSettingsRequest(indexMetaData.getIndex().getName()).settings(settings).             getClient().admin().indices().updateSettings(updateSettingsRequest, ActionListener.wrap(response -> listener.onResponse(true), listener::onFailure)).         } else {             // No nodes currently match the allocation rules so just wait until there is one that does             listener.onResponse(false).         }     } else {         // There are no shards for the index, the index might be gone         listener.onFailure(new IndexNotFoundException(indexMetaData.getIndex())).     } }
