commented;modifiers;parameterAmount;loc;comment;code
false;public;0;6;;@Override public void setUp() throws Exception {     super.setUp().     env = newNodeEnvironment().     metaStateService = new MetaStateService(env, xContentRegistry()). }
false;public;0;5;;@Override public void tearDown() throws Exception {     super.tearDown().     env.close(). }
false;private,static;1;10;;private static IndexMetaData indexMetaData(String name) {     return IndexMetaData.builder(name).settings(Settings.builder().put(IndexMetaData.SETTING_INDEX_UUID, UUIDs.randomBase64UUID()).put(IndexMetaData.SETTING_NUMBER_OF_SHARDS, 1).put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS, 0).put(IndexMetaData.SETTING_VERSION_CREATED, Version.CURRENT).build()).build(). }
false;public;0;5;;public void testWriteLoadIndex() throws Exception {     IndexMetaData index = indexMetaData("test1").     metaStateService.writeIndex("test_write", index).     assertThat(metaStateService.loadIndexState(index.getIndex()), equalTo(index)). }
false;public;0;3;;public void testLoadMissingIndex() throws Exception {     assertThat(metaStateService.loadIndexState(new Index("test1", "test1UUID")), nullValue()). }
false;public;0;7;;public void testWriteLoadGlobal() throws Exception {     MetaData metaData = MetaData.builder().persistentSettings(Settings.builder().put("test1", "value1").build()).build().     metaStateService.writeGlobalState("test_write", metaData).     assertThat(metaStateService.loadGlobalState().persistentSettings(), equalTo(metaData.persistentSettings())). }
false;public;0;11;;public void testWriteGlobalStateWithIndexAndNoIndexIsLoaded() throws Exception {     MetaData metaData = MetaData.builder().persistentSettings(Settings.builder().put("test1", "value1").build()).build().     IndexMetaData index = indexMetaData("test1").     MetaData metaDataWithIndex = MetaData.builder(metaData).put(index, true).build().     metaStateService.writeGlobalState("test_write", metaDataWithIndex).     assertThat(metaStateService.loadGlobalState().persistentSettings(), equalTo(metaData.persistentSettings())).     assertThat(metaStateService.loadGlobalState().hasIndex("test1"), equalTo(false)). }
false;public;0;21;;public void testLoadFullStateBWC() throws Exception {     IndexMetaData indexMetaData = indexMetaData("test1").     MetaData metaData = MetaData.builder().persistentSettings(Settings.builder().put("test1", "value1").build()).put(indexMetaData, true).build().     long globalGeneration = metaStateService.writeGlobalState("test_write", metaData).     long indexGeneration = metaStateService.writeIndex("test_write", indexMetaData).     Tuple<Manifest, MetaData> manifestAndMetaData = metaStateService.loadFullState().     Manifest manifest = manifestAndMetaData.v1().     assertThat(manifest.getGlobalGeneration(), equalTo(globalGeneration)).     assertThat(manifest.getIndexGenerations(), hasKey(indexMetaData.getIndex())).     assertThat(manifest.getIndexGenerations().get(indexMetaData.getIndex()), equalTo(indexGeneration)).     MetaData loadedMetaData = manifestAndMetaData.v2().     assertThat(loadedMetaData.persistentSettings(), equalTo(metaData.persistentSettings())).     assertThat(loadedMetaData.hasIndex("test1"), equalTo(true)).     assertThat(loadedMetaData.index("test1"), equalTo(indexMetaData)). }
false;public;0;9;;public void testLoadEmptyStateNoManifest() throws IOException {     Tuple<Manifest, MetaData> manifestAndMetaData = metaStateService.loadFullState().     Manifest manifest = manifestAndMetaData.v1().     assertTrue(manifest.isEmpty()).     MetaData metaData = manifestAndMetaData.v2().     assertTrue(MetaData.isGlobalStateEquals(metaData, MetaData.EMPTY_META_DATA)). }
false;public;0;9;;public void testLoadEmptyStateWithManifest() throws IOException {     Manifest manifest = Manifest.empty().     metaStateService.writeManifestAndCleanup("test", manifest).     Tuple<Manifest, MetaData> manifestAndMetaData = metaStateService.loadFullState().     assertTrue(manifestAndMetaData.v1().isEmpty()).     MetaData metaData = manifestAndMetaData.v2().     assertTrue(MetaData.isGlobalStateEquals(metaData, MetaData.EMPTY_META_DATA)). }
false;public;0;17;;public void testLoadFullStateMissingGlobalMetaData() throws IOException {     IndexMetaData index = indexMetaData("test1").     long indexGeneration = metaStateService.writeIndex("test", index).     Manifest manifest = new Manifest(randomNonNegativeLong(), randomNonNegativeLong(), Manifest.empty().getGlobalGeneration(), new HashMap<Index, Long>() {          {             put(index.getIndex(), indexGeneration).         }     }).     assertTrue(manifest.isGlobalGenerationMissing()).     metaStateService.writeManifestAndCleanup("test", manifest).     Tuple<Manifest, MetaData> manifestAndMetaData = metaStateService.loadFullState().     assertThat(manifestAndMetaData.v1(), equalTo(manifest)).     MetaData loadedMetaData = manifestAndMetaData.v2().     assertTrue(MetaData.isGlobalStateEquals(loadedMetaData, MetaData.EMPTY_META_DATA)).     assertThat(loadedMetaData.hasIndex("test1"), equalTo(true)).     assertThat(loadedMetaData.index("test1"), equalTo(index)). }
false;public;0;47;;public void testLoadFullStateAndUpdate() throws IOException {     IndexMetaData index = indexMetaData("test1").     MetaData metaData = MetaData.builder().persistentSettings(Settings.builder().put("test1", "value1").build()).put(index, true).build().     long globalGeneration = metaStateService.writeGlobalState("first global state write", metaData).     long indexGeneration = metaStateService.writeIndex("first index state write", index).     Manifest manifest = new Manifest(randomNonNegativeLong(), randomNonNegativeLong(), globalGeneration, new HashMap<Index, Long>() {          {             put(index.getIndex(), indexGeneration).         }     }).     metaStateService.writeManifestAndCleanup("first manifest write", manifest).     MetaData newMetaData = MetaData.builder().persistentSettings(Settings.builder().put("test1", "value2").build()).put(index, true).build().     globalGeneration = metaStateService.writeGlobalState("second global state write", newMetaData).     Tuple<Manifest, MetaData> manifestAndMetaData = metaStateService.loadFullState().     assertThat(manifestAndMetaData.v1(), equalTo(manifest)).     MetaData loadedMetaData = manifestAndMetaData.v2().     assertThat(loadedMetaData.persistentSettings(), equalTo(metaData.persistentSettings())).     assertThat(loadedMetaData.hasIndex("test1"), equalTo(true)).     assertThat(loadedMetaData.index("test1"), equalTo(index)).     manifest = new Manifest(randomNonNegativeLong(), randomNonNegativeLong(), globalGeneration, new HashMap<Index, Long>() {          {             put(index.getIndex(), indexGeneration).         }     }).     metaStateService.writeManifestAndCleanup("second manifest write", manifest).     metaStateService.cleanupGlobalState(globalGeneration).     metaStateService.cleanupIndex(index.getIndex(), indexGeneration).     manifestAndMetaData = metaStateService.loadFullState().     assertThat(manifestAndMetaData.v1(), equalTo(manifest)).     loadedMetaData = manifestAndMetaData.v2().     assertThat(loadedMetaData.persistentSettings(), equalTo(newMetaData.persistentSettings())).     assertThat(loadedMetaData.hasIndex("test1"), equalTo(true)).     assertThat(loadedMetaData.index("test1"), equalTo(index)). }
