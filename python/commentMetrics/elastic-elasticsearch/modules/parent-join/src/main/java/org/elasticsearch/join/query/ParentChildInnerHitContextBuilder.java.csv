commented;modifiers;parameterAmount;loc;comment;code
false;protected;2;16;;@Override protected void doBuild(SearchContext context, InnerHitsContext innerHitsContext) throws IOException {     QueryShardContext queryShardContext = context.getQueryShardContext().     ParentJoinFieldMapper joinFieldMapper = ParentJoinFieldMapper.getMapper(context.mapperService()).     if (joinFieldMapper != null) {         String name = innerHitBuilder.getName() != null ? innerHitBuilder.getName() : typeName.         JoinFieldInnerHitSubContext joinFieldInnerHits = new JoinFieldInnerHitSubContext(name, context, typeName, fetchChildInnerHits, joinFieldMapper).         setupInnerHitsContext(queryShardContext, joinFieldInnerHits).         innerHitsContext.addInnerHitDefinition(joinFieldInnerHits).     } else {         if (innerHitBuilder.isIgnoreUnmapped() == false) {             throw new IllegalStateException("no join field has been configured").         }     } }
false;public;1;75;;@Override public TopDocsAndMaxScore[] topDocs(SearchHit[] hits) throws IOException {     Weight innerHitQueryWeight = createInnerHitQueryWeight().     TopDocsAndMaxScore[] result = new TopDocsAndMaxScore[hits.length].     for (int i = 0. i < hits.length. i++) {         SearchHit hit = hits[i].         String joinName = getSortedDocValue(joinFieldMapper.name(), context, hit.docId()).         if (joinName == null) {             result[i] = new TopDocsAndMaxScore(Lucene.EMPTY_TOP_DOCS, Float.NaN).             continue.         }         QueryShardContext qsc = context.getQueryShardContext().         ParentIdFieldMapper parentIdFieldMapper = joinFieldMapper.getParentIdFieldMapper(typeName, fetchChildInnerHits == false).         if (parentIdFieldMapper == null) {             result[i] = new TopDocsAndMaxScore(Lucene.EMPTY_TOP_DOCS, Float.NaN).             continue.         }         Query q.         if (fetchChildInnerHits) {             Query hitQuery = parentIdFieldMapper.fieldType().termQuery(hit.getId(), qsc).             q = new BooleanQuery.Builder().add(hitQuery, BooleanClause.Occur.FILTER).add(joinFieldMapper.fieldType().termQuery(typeName, qsc), BooleanClause.Occur.FILTER).build().         } else {             String parentId = getSortedDocValue(parentIdFieldMapper.name(), context, hit.docId()).             q = context.mapperService().fullName(IdFieldMapper.NAME).termQuery(parentId, qsc).         }         Weight weight = context.searcher().createWeight(context.searcher().rewrite(q), ScoreMode.COMPLETE_NO_SCORES, 1f).         if (size() == 0) {             TotalHitCountCollector totalHitCountCollector = new TotalHitCountCollector().             for (LeafReaderContext ctx : context.searcher().getIndexReader().leaves()) {                 intersect(weight, innerHitQueryWeight, totalHitCountCollector, ctx).             }             result[i] = new TopDocsAndMaxScore(new TopDocs(new TotalHits(totalHitCountCollector.getTotalHits(), TotalHits.Relation.EQUAL_TO), Lucene.EMPTY_SCORE_DOCS), Float.NaN).         } else {             int topN = Math.min(from() + size(), context.searcher().getIndexReader().maxDoc()).             TopDocsCollector<?> topDocsCollector.             MaxScoreCollector maxScoreCollector = null.             if (sort() != null) {                 topDocsCollector = TopFieldCollector.create(sort().sort, topN, Integer.MAX_VALUE).                 if (trackScores()) {                     maxScoreCollector = new MaxScoreCollector().                 }             } else {                 topDocsCollector = TopScoreDocCollector.create(topN, Integer.MAX_VALUE).                 maxScoreCollector = new MaxScoreCollector().             }             try {                 for (LeafReaderContext ctx : context.searcher().getIndexReader().leaves()) {                     intersect(weight, innerHitQueryWeight, MultiCollector.wrap(topDocsCollector, maxScoreCollector), ctx).                 }             } finally {                 clearReleasables(Lifetime.COLLECTION).             }             TopDocs topDocs = topDocsCollector.topDocs(from(), size()).             float maxScore = Float.NaN.             if (maxScoreCollector != null) {                 maxScore = maxScoreCollector.getMaxScore().             }             result[i] = new TopDocsAndMaxScore(topDocs, maxScore).         }     }     return result. }
false;private;3;16;;private String getSortedDocValue(String field, SearchContext context, int docId) {     try {         List<LeafReaderContext> ctxs = context.searcher().getIndexReader().leaves().         LeafReaderContext ctx = ctxs.get(ReaderUtil.subIndex(docId, ctxs)).         SortedDocValues docValues = ctx.reader().getSortedDocValues(field).         int segmentDocId = docId - ctx.docBase.         if (docValues == null || docValues.advanceExact(segmentDocId) == false) {             return null.         }         int ord = docValues.ordValue().         BytesRef joinName = docValues.lookupOrd(ord).         return joinName.utf8ToString().     } catch (IOException e) {         throw ExceptionsHelper.convertToElastic(e).     } }
