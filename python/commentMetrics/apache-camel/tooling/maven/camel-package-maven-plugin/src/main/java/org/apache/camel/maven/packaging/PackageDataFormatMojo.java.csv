commented;modifiers;parameterAmount;loc;comment;code
true;public;0;3;/**  * Execute goal.  *  * @throws org.apache.maven.plugin.MojoExecutionException execution of the main class or one of the  *                                                        threads it generated failed.  * @throws org.apache.maven.plugin.MojoFailureException   something bad happened...  */ ;/**  * Execute goal.  *  * @throws org.apache.maven.plugin.MojoExecutionException execution of the main class or one of the  *                                                        threads it generated failed.  * @throws org.apache.maven.plugin.MojoFailureException   something bad happened...  */ public void execute() throws MojoExecutionException, MojoFailureException {     prepareDataFormat(getLog(), project, projectHelper, dataFormatOutDir, schemaOutDir, buildContext). }
false;public,static;6;102;;public static int prepareDataFormat(Log log, MavenProject project, MavenProjectHelper projectHelper, File dataFormatOutDir, File schemaOutDir, BuildContext buildContext) throws MojoExecutionException {     File camelMetaDir = new File(dataFormatOutDir, "META-INF/services/org/apache/camel/").     // can stop the build before the end and eclipse always needs to know about that directory     if (projectHelper != null) {         projectHelper.addResource(project, dataFormatOutDir.getPath(), Collections.singletonList("**/dataformat.properties"), Collections.emptyList()).     }     if (!PackageHelper.haveResourcesChanged(log, project, buildContext, "META-INF/services/org/apache/camel/dataformat")) {         return 0.     }     Map<String, String> javaTypes = new HashMap<>().     StringBuilder buffer = new StringBuilder().     int count = 0.     File f = new File(project.getBasedir(), "target/classes").     f = new File(f, "META-INF/services/org/apache/camel/dataformat").     if (f.exists() && f.isDirectory()) {         File[] files = f.listFiles().         if (files != null) {             for (File file : files) {                 String javaType = readClassFromCamelResource(file, buffer, buildContext).                 if (!file.isDirectory() && file.getName().charAt(0) != '.') {                     count++.                 }                 if (javaType != null) {                     javaTypes.put(file.getName(), javaType).                 }             }         }     }     // is this from Apache Camel then the data format is out of the box and we should enrich the json schema with more details     boolean apacheCamel = "org.apache.camel".equals(project.getGroupId()).     // and create json schema model file for this data format     try {         if (apacheCamel && count > 0) {             File core = findCamelCoreDirectory(project.getBasedir()).             if (core != null) {                 for (Map.Entry<String, String> entry : javaTypes.entrySet()) {                     String name = entry.getKey().                     String javaType = entry.getValue().                     String modelName = asModelName(name).                     InputStream is = new FileInputStream(new File(core, "target/classes/org/apache/camel/model/dataformat/" + modelName + ".json")).                     String json = loadText(is).                     DataFormatModel dataFormatModel = extractDataFormatModel(project, json, modelName, name, javaType).                     if (log.isDebugEnabled()) {                         log.debug("Model: " + dataFormatModel).                     }                     // build json schema for the data format                     String properties = after(json, "  \"properties\": {").                     // special prepare for bindy/json properties                     properties = prepareBindyProperties(name, properties).                     properties = prepareJsonProperties(name, properties).                     String schema = createParameterJsonSchema(dataFormatModel, properties).                     if (log.isDebugEnabled()) {                         log.debug("JSon schema:\n" + schema).                     }                     // write this to the directory                     Path out = schemaOutDir.toPath().resolve(schemaSubDirectory(dataFormatModel.getJavaType())).resolve(name + ".json").                     updateResource(buildContext, out, schema).                     if (log.isDebugEnabled()) {                         log.debug("Generated " + out + " containing JSon schema for " + name + " data format").                     }                 }             } else {                 throw new MojoExecutionException("Error finding core/camel-core/target/camel-core-" + project.getVersion() + ".jar file. Make sure camel-core has been built first.").             }         }     } catch (Exception e) {         throw new MojoExecutionException("Error loading dataformat model from camel-core. Reason: " + e, e).     }     if (count > 0) {         String names = buffer.toString().         Path outFile = camelMetaDir.toPath().resolve("dataformat.properties").         String properties = createProperties(project, "dataFormats", names).         updateResource(buildContext, outFile, properties).         log.info("Generated " + outFile + " containing " + count + " Camel " + (count > 1 ? "dataformats: " : "dataformat: ") + names).     } else {         log.debug("No META-INF/services/org/apache/camel/dataformat directory found. Are you sure you have created a Camel data format?").     }     return count. }
false;private,static;5;47;;private static DataFormatModel extractDataFormatModel(MavenProject project, String json, String modelName, String name, String javaType) throws Exception {     DataFormatModel dataFormatModel = new DataFormatModel().     dataFormatModel.setName(name).     dataFormatModel.setTitle("").     dataFormatModel.setModelName(modelName).     dataFormatModel.setLabel("").     dataFormatModel.setDescription(project.getDescription()).     dataFormatModel.setJavaType(javaType).     dataFormatModel.setGroupId(project.getGroupId()).     dataFormatModel.setArtifactId(project.getArtifactId()).     dataFormatModel.setVersion(project.getVersion()).     List<Map<String, String>> rows = JSonSchemaHelper.parseJsonSchema("model", json, false).     for (Map<String, String> row : rows) {         if (row.containsKey("title")) {             String title = row.get("title").             dataFormatModel.setTitle(asModelTitle(name, title)).         }         if (row.containsKey("label")) {             dataFormatModel.setLabel(row.get("label")).         }         if (row.containsKey("deprecated")) {             dataFormatModel.setDeprecated(row.get("deprecated")).         }         if (row.containsKey("deprecationNote")) {             dataFormatModel.setDeprecationNote(row.get("deprecationNote")).         }         if (row.containsKey("javaType")) {             dataFormatModel.setModelJavaType(row.get("javaType")).         }         if (row.containsKey("firstVersion")) {             dataFormatModel.setFirstVersion(row.get("firstVersion")).         }         // favor description from the model schema         if (row.containsKey("description")) {             dataFormatModel.setDescription(row.get("description")).         }     }     // first version special for json     String firstVersion = prepareJsonFirstVersion(name).     if (firstVersion != null) {         dataFormatModel.setFirstVersion(firstVersion).     }     return dataFormatModel. }
false;private,static;2;16;;private static String prepareBindyProperties(String name, String properties) {     String bindy = "\"enum\": [ \"Csv\", \"Fixed\", \"KeyValue\" ], \"deprecated\": \"false\", \"secret\": \"false\"".     String bindyCsv = "\"enum\": [ \"Csv\", \"Fixed\", \"KeyValue\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Csv\"".     String bindyFixed = "\"enum\": [ \"Csv\", \"Fixed\", \"KeyValue\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Fixed\"".     String bindyKvp = "\"enum\": [ \"Csv\", \"Fixed\", \"KeyValue\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"KeyValue\"".     if ("bindy-csv".equals(name)) {         properties = properties.replace(bindy, bindyCsv).     } else if ("bindy-fixed".equals(name)) {         properties = properties.replace(bindy, bindyFixed).     } else if ("bindy-kvp".equals(name)) {         properties = properties.replace(bindy, bindyKvp).     }     return properties. }
false;private,static;2;22;;private static String prepareJsonProperties(String name, String properties) {     String json = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"XStream\"".     String jsonGson = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Gson\"".     String jsonJackson = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Jackson\"".     String jsonJohnzon = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Johnzon\"".     String jsonXStream = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"XStream\"".     String jsonFastjson = "\"enum\": [ \"Gson\", \"Jackson\", \"Johnzon\", \"XStream\", \"Fastjson\" ], \"deprecated\": \"false\", \"secret\": \"false\", \"defaultValue\": \"Fastjson\"".     if ("json-gson".equals(name)) {         properties = properties.replace(json, jsonGson).     } else if ("json-jackson".equals(name)) {         properties = properties.replace(json, jsonJackson).     } else if ("json-johnzon".equals(name)) {         properties = properties.replace(json, jsonJohnzon).     } else if ("json-xstream".equals(name)) {         properties = properties.replace(json, jsonXStream).     } else if ("json-fastjson".equals(name)) {         properties = properties.replace(json, jsonFastjson).     }     return properties. }
false;private,static;1;15;;private static String prepareJsonFirstVersion(String name) {     if ("json-gson".equals(name)) {         return "2.10.0".     } else if ("json-jackson".equals(name)) {         return "2.0.0".     } else if ("json-johnzon".equals(name)) {         return "2.18.0".     } else if ("json-xstream".equals(name)) {         return "2.0.0".     } else if ("json-fastjson".equals(name)) {         return "2.20.0".     }     return null. }
false;private,static;3;30;;private static String readClassFromCamelResource(File file, StringBuilder buffer, BuildContext buildContext) throws MojoExecutionException {     // skip directories as there may be a sub .resolver directory     if (file.isDirectory()) {         return null.     }     String name = file.getName().     if (name.charAt(0) != '.') {         if (buffer.length() > 0) {             buffer.append(" ").         }         buffer.append(name).     }     if (!buildContext.hasDelta(file)) {         // (but we do need the name above!)         return null.     }     // find out the javaType for each data format     try {         String text = loadText(new FileInputStream(file)).         Map<String, String> map = parseAsMap(text).         return map.get("class").     } catch (IOException e) {         throw new MojoExecutionException("Failed to read file " + file + ". Reason: " + e, e).     } }
false;private,static;1;11;;private static String asModelName(String name) {     // special for some data formats     if ("json-gson".equals(name) || "json-jackson".equals(name) || "json-johnzon".equals(name) || "json-xstream".equals(name) || "json-fastjson".equals(name)) {         return "json".     } else if ("bindy-csv".equals(name) || "bindy-fixed".equals(name) || "bindy-kvp".equals(name)) {         return "bindy".     } else if ("yaml-snakeyaml".equals(name)) {         return "yaml".     }     return name. }
false;private,static;2;23;;private static String asModelTitle(String name, String title) {     // special for some data formats     if ("json-gson".equals(name)) {         return "JSon GSon".     } else if ("json-jackson".equals(name)) {         return "JSon Jackson".     } else if ("json-johnzon".equals(name)) {         return "JSon Johnzon".     } else if ("json-xstream".equals(name)) {         return "JSon XStream".     } else if ("json-fastjson".equals(name)) {         return "JSon Fastjson".     } else if ("bindy-csv".equals(name)) {         return "Bindy CSV".     } else if ("bindy-fixed".equals(name)) {         return "Bindy Fixed Length".     } else if ("bindy-kvp".equals(name)) {         return "Bindy Key Value Pair".     } else if ("yaml-snakeyaml".equals(name)) {         return "YAML SnakeYAML".     }     return title. }
false;private,static;1;5;;private static String schemaSubDirectory(String javaType) {     int idx = javaType.lastIndexOf('.').     String pckName = javaType.substring(0, idx).     return pckName.replace('.', '/'). }
false;private,static;2;32;;private static String createParameterJsonSchema(DataFormatModel dataFormatModel, String schema) {     StringBuilder buffer = new StringBuilder("{").     // dataformat model     buffer.append("\n \"dataformat\": {").     buffer.append("\n    \"name\": \"").append(dataFormatModel.getName()).append("\",").     buffer.append("\n    \"kind\": \"").append("dataformat").append("\",").     buffer.append("\n    \"modelName\": \"").append(dataFormatModel.getModelName()).append("\",").     if (dataFormatModel.getTitle() != null) {         buffer.append("\n    \"title\": \"").append(dataFormatModel.getTitle()).append("\",").     }     if (dataFormatModel.getDescription() != null) {         buffer.append("\n    \"description\": \"").append(dataFormatModel.getDescription()).append("\",").     }     boolean deprecated = "true".equals(dataFormatModel.getDeprecated()).     buffer.append("\n    \"deprecated\": ").append(deprecated).append(",").     if (dataFormatModel.getFirstVersion() != null) {         buffer.append("\n    \"firstVersion\": \"").append(dataFormatModel.getFirstVersion()).append("\",").     }     buffer.append("\n    \"label\": \"").append(dataFormatModel.getLabel()).append("\",").     buffer.append("\n    \"javaType\": \"").append(dataFormatModel.getJavaType()).append("\",").     if (dataFormatModel.getModelJavaType() != null) {         buffer.append("\n    \"modelJavaType\": \"").append(dataFormatModel.getModelJavaType()).append("\",").     }     buffer.append("\n    \"groupId\": \"").append(dataFormatModel.getGroupId()).append("\",").     buffer.append("\n    \"artifactId\": \"").append(dataFormatModel.getArtifactId()).append("\",").     buffer.append("\n    \"version\": \"").append(dataFormatModel.getVersion()).append("\"").     buffer.append("\n  },").     buffer.append("\n  \"properties\": {").     buffer.append(schema).     return buffer.toString(). }
false;public;0;3;;public String getName() {     return name. }
false;public;1;3;;public void setName(String name) {     this.name = name. }
false;public;0;3;;public String getTitle() {     return title. }
false;public;1;3;;public void setTitle(String title) {     this.title = title. }
false;public;0;3;;public String getModelName() {     return modelName. }
false;public;1;3;;public void setModelName(String modelName) {     this.modelName = modelName. }
false;public;0;3;;public String getModelJavaType() {     return modelJavaType. }
false;public;1;3;;public void setModelJavaType(String modelJavaType) {     this.modelJavaType = modelJavaType. }
false;public;0;3;;public String getDescription() {     return description. }
false;public;1;3;;public void setDescription(String description) {     this.description = description. }
false;public;0;3;;public String getFirstVersion() {     return firstVersion. }
false;public;1;3;;public void setFirstVersion(String firstVersion) {     this.firstVersion = firstVersion. }
false;public;0;3;;public String getLabel() {     return label. }
false;public;1;3;;public void setLabel(String label) {     this.label = label. }
false;public;0;3;;public String getDeprecated() {     return deprecated. }
false;public;1;3;;public void setDeprecated(String deprecated) {     this.deprecated = deprecated. }
false;public;0;3;;public String getDeprecationNote() {     return deprecationNote. }
false;public;1;3;;public void setDeprecationNote(String deprecationNote) {     this.deprecationNote = deprecationNote. }
false;public;0;3;;public String getJavaType() {     return javaType. }
false;public;1;3;;public void setJavaType(String javaType) {     this.javaType = javaType. }
false;public;0;3;;public String getGroupId() {     return groupId. }
false;public;1;3;;public void setGroupId(String groupId) {     this.groupId = groupId. }
false;public;0;3;;public String getArtifactId() {     return artifactId. }
false;public;1;3;;public void setArtifactId(String artifactId) {     this.artifactId = artifactId. }
false;public;0;3;;public String getVersion() {     return version. }
false;public;1;3;;public void setVersion(String version) {     this.version = version. }
false;public;0;16;;@Override public String toString() {     return "DataFormatModel[" + "name='" + name + '\'' + ", title='" + title + '\'' + ", modelName='" + modelName + '\'' + ", description='" + description + '\'' + ", label='" + label + '\'' + ", deprecated='" + deprecated + '\'' + ", javaType='" + javaType + '\'' + ", modelJavaType='" + modelJavaType + '\'' + ", groupId='" + groupId + '\'' + ", artifactId='" + artifactId + '\'' + ", version='" + version + '\'' + ']'. }
